<?xml version="1.0" encoding="UTF-8"?>
<Module>
<ModulePrefs title="__UP_title__" description="Never miss your friends' birthdays again!" author="Adam">
    <Require feature="analytics" /> 
</ModulePrefs>
<UserPref name="title" display_name="Title" required="false" default_value="Never Forget" />
<UserPref name="birthdays" display_name="Add Birthdays" datatype="list" required="true" default_value="YYYY/MM/DD;Name|MM/DD;Name" /> 
<UserPref name="showDays" display_name="Visible Birthdays" default_value="7" datatype="enum" >
  <EnumValue value="3" />
  <EnumValue value="4" />
  <EnumValue value="5" />
  <EnumValue value="6" />
  <EnumValue value="7" />
  <EnumValue value="10" />
  <EnumValue value="14" />
</UserPref>
<Content type="html"><![CDATA[
  <style type="text/css">

  </style>

  <script>
    // Track this gadget using Google Analytics.
    _IG_Analytics("UA-310375-4", "/birthday-gadget");
  </script>

  <script type="text/javascript">
    var prefs__MODULE_ID__ = new _IG_Prefs(__MODULE_ID__);
    var errorStr__MODULE_ID__="";
    var html__MODULE_ID__="<table><tr><th>Date</th><th>Name</th><th>Age</th></tr>";
    var today=new Date();
    
    function sortDate(a,b){
      tempa=(a.length>5)?a.substr(5):a; tempb=(b.length>5)?b.substr(5):b;
      montha=tempa.substr(0,2); monthb=tempb.substr(0,2);
      daya=tempa.substr(3,2); dayb=tempb.substr(3,2);
      
      if(montha>monthb) return 1;
      else if(montha<monthb) return -1;
      else {
        if(daya>dayb) return 1;
        else if(daya<dayb) return -1;
        else return 0;}}
    
    function setup__MODULE_ID__() {
      var birthdayArray=prefs.getArray("birthdays");
      var year=1000*60*60*24*365;
      var displayArray=new Array();
      
      for(var i=0; i<birthdayArray.length; i++){
        if(i==prefs.getInt("showDays")) break;
        birthdayArray.sort(sortDate);
        tempSplit=birthdayArray[i].split(";");
        
        if(tempSplit.length==1){
          errorStr__MODULE_ID__+="Error: "+birthdayArray[i]+" incorrectly split, use a ';' between date and name.<br />";
          continue;}
        
        date=tempSplit[0];
        name=tempSplit[1];
        if(date=="YYYY/MM/DD" || date=="MM/DD") continue;
        
        if(date.length==5){
          if(/[0-9]{2}\/[0-9]{2}/.test(date)) displayArray[]=[date, name];
          else{
            errorStr__MODULE_ID__+="Error: "+birthdayArray[i]+" date is not formatted correctly, use MM/DD.<br />";
            continue;}}
        else if(tempSplit[0].length==10){
          if(/[0-9]{4}\/[0-9]{2}\/[0-9]{2}/.test(date)) displayArray[]=[date, name];
          else{
            errorStr__MODULE_ID__+="Error: "+birthdayArray[i]+" date is not formatted correctly, use YYYY/MM/DD.<br />";
            continue;}}
        else{
          errorStr__MODULE_ID__+="Error: "+birthdayArray[i]+" date is not formatted correctly, use YYYY/MM/DD or MM/DD.<br />";
          continue;}}
        
      if(displayArray.length==0) error__MODULE_ID__+="No birthdays to display";
      else{
        for(var i=0; i<displayArray.length; i++){
          var age="";
          if(displayArray[i][0].length>5){
            var d = new Date();
            var b = Date.parse(displayArray[i][0]);
            age=Math.floor((d-b)/year);}
          html__MODULE_ID__+="<tr><td>"+displayArray[i][0]+"</td><td>"+displayArray[i][1]+"</td><td>"+age+"</td></tr>";}
        html__MODULE_ID__+="</table>";}
        
      
      _gel("error__MODULE_ID__").innerHTML=error__MODULE_ID__;
      _gel("table__MODULE_ID__").innerHTML=html__MODULE_ID__;}
      
      
      
      

    
    _IG_RegisterOnloadHandler(setup__MODULE_ID__);

  </script>
  <div id="error__MODULE_ID__"></div>
  <div id="table__MODULE_ID__"></div>


]]></Content>
</Module>
