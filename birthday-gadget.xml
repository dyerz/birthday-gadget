<?xml version="1.0" encoding="UTF-8"?>
<Module>
<ModulePrefs title="__UP_title__" description="Never miss your friends' birthdays again!" author="Adam">
    <Require feature="analytics" /> 
</ModulePrefs>
<UserPref name="title" display_name="Title" required="false" default_value="Never Forget" />
<UserPref name="birthdays" display_name="Add Birthdays" datatype="list" required="true" default_value="YYYY/MM/DD;Name|MM/DD;Name" /> 
<UserPref name="showDays" display_name="Visible Birthdays" default_value="7" datatype="enum" >
  <EnumValue value="3" />
  <EnumValue value="4" />
  <EnumValue value="5" />
  <EnumValue value="6" />
  <EnumValue value="7" />
  <EnumValue value="10" />
  <EnumValue value="14" />
</UserPref>
<Content type="html"><![CDATA[
  <style type="text/css">
    #table__MODULE_ID__{
      width: 100%;
    
    
    }
    .bdtable{
      width: 100%;
      margin: 0;
      padding: 0;
    }
    .bdtable th{
      border-bottom: 1px solid #000;
    }
    .bdtable td{
      text-align: center;
    }
  </style>

  <script>
    // Track this gadget using Google Analytics.
    _IG_Analytics("UA-310375-4", "/birthday-gadget");
  </script>

  <script type="text/javascript">
    var prefs__MODULE_ID__ = new _IG_Prefs(__MODULE_ID__);
    var errorStr__MODULE_ID__="";
    var html__MODULE_ID__="";
    var today=new Date();
    
    function sortDate__MODULE_ID__(a,b){
      splita=a.split(";"); splitb=b.split(";");
      tempa=(splita[0].length>5)?splita[0].substr(5):splita[0];
      tempb=(splitb[0].length>5)?splitb[0].substr(5):splitb[0];
      montha=tempa.substr(0,2); monthb=tempb.substr(0,2);
      daya=tempa.substr(3,2); dayb=tempb.substr(3,2);
      
      if(montha>monthb) return 1;
      else if(montha<monthb) return -1;
      else {
        if(daya>dayb) return 1;
        else if(daya<dayb) return -1;
        else return 0;}}
    
    function setup__MODULE_ID__() {
      var birthdayArray=prefs__MODULE_ID__.getArray("birthdays");
      var year=1000*60*60*24*365;
      var displayArray=new Array();
      birthdayArray.sort(sortDate__MODULE_ID__);
      
      for(var i=0; i<birthdayArray.length; i++){
        tempSplit=birthdayArray[i].split(";");
        
        if(tempSplit.length==1){
          errorStr__MODULE_ID__+="Error: "+birthdayArray[i]+" incorrectly split, use a ';' between date and name.<br />";
          continue;}
        
        date=tempSplit[0];
        name=tempSplit[1];
        if(date=="YYYY/MM/DD" || date=="MM/DD") continue;
        
        if(date.length==5){
          if(/[0-9]{2}\/[0-9]{2}/.test(date)) displayArray.push(Array(date, name));
          else{
            errorStr__MODULE_ID__+="Error: "+birthdayArray[i]+" date is not formatted correctly, use MM/DD.<br />";
            continue;}}
        else if(tempSplit[0].length==10){
          if(/[0-9]{4}\/[0-9]{2}\/[0-9]{2}/.test(date)) displayArray.push(Array(date, name));
          else{
            errorStr__MODULE_ID__+="Error: "+birthdayArray[i]+" date is not formatted correctly, use YYYY/MM/DD.<br />";
            continue;}}
        else{
          errorStr__MODULE_ID__+="Error: "+birthdayArray[i]+" date is not formatted correctly, use YYYY/MM/DD or MM/DD.<br />";
          continue;}}
        
      if(displayArray.length==0) errorStr__MODULE_ID__+="No birthdays to display, please <a href=\"#\" onClick=\"_edit(__MODULE_ID__)\">Edit Settings</a> to add your own the ";
      else{
        html__MODULE_ID__+="<table class=\"bdtable\"><tr><th>Date</th><th style=\"width: 100%;\">Name</th><th>Age</th></tr>";
        for(var i=0; i<displayArray.length; i++){
          if(i==prefs__MODULE_ID__.getInt("showDays")) break;
          var age="";
          if(displayArray[i][0].length>5){
            var d = new Date();
            var b = Date.parse(displayArray[i][0]);
            age=Math.floor((d-b)/year);
            if(age==0) age=Math.floor(((d-b)/year)*12)+"M";
            else age+="Y";}
          html__MODULE_ID__+="<tr><td>"+displayArray[i][0]+"</td><td>"+displayArray[i][1]+"</td><td>"+age+"</td></tr>";}
        html__MODULE_ID__+="</table>";}
        
      
      _gel("error__MODULE_ID__").innerHTML=errorStr__MODULE_ID__;
      _gel("table__MODULE_ID__").innerHTML=html__MODULE_ID__;}

    _IG_RegisterOnloadHandler(setup__MODULE_ID__);

  </script>
  <div id="error__MODULE_ID__"></div>
  <div id="table__MODULE_ID__"></div>

]]></Content>
</Module>
