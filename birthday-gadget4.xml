<?xml version="1.0" encoding="UTF-8"?>
<Module>
	<ModulePrefs title="Number 4"
		directory_title="Debug"
		description="Debug"
		screenshot="http://birthday-gadget.googlecode.com/svn/trunk/screenshot.png"
		thumbnail="http://birthday-gadget.googlecode.com/svn/trunk/thumbnail.png"
		author="Adam"
		author_email="birthdaygadget@gmail.com"
		height="200">
		<Require feature="dynamic-height"/>
		<Require feature="idi" />
		<Require feature="locked-domain" />
		<Require feature="setprefs"/>
	</ModulePrefs>
	<UserPref name="debug" display_name="Debug" default_value="" datatype="string" />
	<UserPref name="url" display_name="URL" default_value="" datatype="string" />
	<UserPref name="liteData" default_value="" datatype="hidden" />
	<Content type="html">
	<![CDATA[
	<style>
		.welcomeTable
		{
			width: 100%;
			height: 100%; 
			border: 1px solid #000000; 
			border-collapse: collapse;
			vertical-align: middle;
			text-align: center;
		}
		.welcomeTable td, .welcomeTable tr
		{
			border: 1px solid #000000; 
		}
		
		.mainTable
		{
			width: 100%;
			height: 100%;
			border-collapse: collapse;
			vertical-align: middle;
			text-align: center;
		}
		
		
	</style>
	<script type="text/javascript" src="https://www.google.com/jsapi"></script>
	<script type="text/javascript">
		google.setOnLoadCallback(init);
		google.load('visualization', '1', {packages: ['table']});	
		
		var _prefs = new gadgets.Prefs();

		function init() 
		{
			var debug = _prefs.getString("debug");
			
			if(debug === "")
			{
				goWelcome();
			}
			else
			{
				goChoice();
			}
		}
		
		function goWelcome()
		{
			var html = '';
			html += '<table class="welcomeTable"><tr>';
			html += '<td><a onClick="goLite();">Lite</a></td>';
			html += '<td><a onClick="goFull();">Full</a></td>';
			html += '</tr></table>';
			
			document.getElementById('content').innerHTML = html;
		}
		
		function goChoice()
		{
			var url = _prefs.getString("url");
			
			if(url === "")
			{
				goLite();
			}
			else
			{
				goFull();
			}
		}
		
		function goLite()
		{
			var liteData = buildLiteData(_prefs.getString("liteData"));
			
			goMainTable(liteData);
		}
		
		function buildLiteData(liteString)
		{
			var liteData = new google.visualization.DataTable();
		
			
			return liteData;
		}
		
		function goFull()
		{
			var url = _prefs.getString("url");
			
			if(url === "")
			{
				goEnterURL();
			}
			else
			{
				var query = new google.visualization.Query(_prefs.getString("url"));

				query.setQuery("select A,B,C format A 'yyyy/MM/dd'");
				query.send(handleQueryResponse);
			}
		}
		
		function goEnterURL()
		{
			var html = '';
			html += '<input id="urlInput" type="text" style="width:100%" /><br />';
			html += '<input type="button" text="Set" onClick="saveURL();" />';
			
			document.getElementById('content').innerHTML = html;
			
			goChoice();
		}
		
		function saveURL()
		{
			_prefs.set("url", 'https://spreadsheets.google.com/tq?key=pC4N73ZOVzvp9XsOBCaK7KA');
		}
		
		function handleQueryResponse(response)
		{
			var gadgetHelper = new google.visualization.GadgetHelper();
			if (!gadgetHelper.validateResponse(response))
			{
				goChoice();
				return;
			}
			
			var data = response.getDataTable();
			
			var formatter0 = new google.visualization.DateFormat({pattern: "M/d"});
			formatter0.format(data, 0);
			
			var formatter = new google.visualization.PatternFormat('<a href="mailto:{1} target="_blank">{0}</a>');
			formatter.format(data, [1, 2]);
			
			data.setColumnLabel(0, "Date");
			data.setColumnLabel(1, "Name");
			
			goMainTable(data);
		}		
		
		function goMainTable(input)
		{
			var table = new google.visualization.Table(document.getElementById('content'));
		
			var view = new google.visualization.DataView(input);
			view.setColumns([0, 1]);
			
			table.draw(view, {allowHtml: true});
		}
		
		
	</script>
	<div id="content">
		<img src="http://birthday-gadget.googlecode.com/svn/trunk/bd_content/spinner.gif" />
	</div>
	]]>
	</Content>
</Module>