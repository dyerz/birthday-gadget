<?xml version="1.0" encoding="UTF-8"?>
<Module>
<ModulePrefs title="__UP_title__"
  directory_title="__MSG_title__"
  description="__MSG_description__"
  screenshot="http://birthday-gadget.googlecode.com/svn/trunk/screenshot.png"
  thumbnail="http://birthday-gadget.googlecode.com/svn/trunk/thumbnail.png"
  author="Adam"
  author_email="birthdaygadget@gmail.com"
  height="100">
    <Locale messages="http://birthday-gadget.googlecode.com/svn/trunk/bd_content/ALL_ALL.xml" />
    <Locale lang="de" messages="http://birthday-gadget.googlecode.com/svn/trunk/bd_content/de_ALL.xml" />
    <Locale lang="es" messages="http://birthday-gadget.googlecode.com/svn/trunk/bd_content/es_ALL.xml" />
    <Locale lang="fr" messages="http://birthday-gadget.googlecode.com/svn/trunk/bd_content/fr_ALL.xml" />
    <Locale lang="it" messages="http://birthday-gadget.googlecode.com/svn/trunk/bd_content/it_ALL.xml" />
    <Locale lang="ko" messages="http://birthday-gadget.googlecode.com/svn/trunk/bd_content/ko_ALL.xml" />
    <Locale lang="ru" messages="http://birthday-gadget.googlecode.com/svn/trunk/bd_content/ru_ALL.xml" />
    <Require feature="analytics" /> 
    <Require feature="dynamic-height" />
    <Require feature="setprefs"/>
</ModulePrefs>
<UserPref name="title" display_name="__MSG_titleName__" required="false" default_value="__MSG_title__" />
<UserPref name="birthdays" datatype="hidden" default_value="" /> 
<UserPref name="showBDay" display_name="__MSG_showName__" default_value="5" datatype="enum" >
  <EnumValue value="1" />
  <EnumValue value="2" />
  <EnumValue value="3" />
  <EnumValue value="4" />
  <EnumValue value="5" />
  <EnumValue value="6" />
  <EnumValue value="7" />
  <EnumValue value="8" />
  <EnumValue value="9" />
  <EnumValue value="10" />
</UserPref>
<UserPref name="warning" display_name="__MSG_noticeName__" default_value="7" datatype="enum" >
  <EnumValue value="3" />
  <EnumValue value="7" />
  <EnumValue value="10" />
  <EnumValue value="14" />
  <EnumValue value="21" />
</UserPref>
<Content type="html"><![CDATA[
  <style type="text/css">
    #quick__MODULE_ID__{
      font-size: 10px;
      text-align: right;
      width: 100%;
    }
  
    #error__MODULE_ID__{
      font-size: 12px;
      color: red;
      padding: 8px;
    }
  
    #error__MODULE_ID__{
      font-size: 12px;
      padding: 8px;
    }
  
    #table__MODULE_ID__{
      width: 100%;
    }
    
    .bdtable{
      width: 100%;
      margin: 0;
      padding: 0;
    }
    
    .bdtable th{
      font-size: 18px;
      border-bottom: 1px solid #000;
    }
    
    .bdtable td{
      font-size: 16px;
      text-align: center;
    }
  </style>

  <script>_IG_Analytics("UA-310375-4", "/birthday-gadget");</script>

  <script type="text/javascript">
    var prefs__MODULE_ID__=new _IG_Prefs(__MODULE_ID__);
    var quick__MODULE_ID__="";
    var error__MODULE_ID__="";
    var debug__MODULE_ID__="";
    var html__MODULE_ID__="";
    var note__MODULE_ID__="";
    var today=new Date();
    var sError__MODULE_ID__="";
    var modArray__MODULE_ID__="";
    var displayArray__MODULE_ID__=new Array();
    var saved__MODULE_ID__=true;
     
    String.prototype.trim = function() { return this.replace(/^\s+|\s+$/g,"");}
    String.leftPad = function (val, size, ch) {
      var result = new String(val);
      if (ch == null) {ch = " ";}
      while (result.length < size) {result = ch + result;}
      return result;}

/* NEW CODE ********************************************************* */
    function errorStr__MODULE_ID__(message){ error__MODULE_ID__=message+sError__MODULE_ID__; return false;}
    
    function testDate__MODULE_ID__(inputDate){
      if(inputDate.length<=5){
        var mDays=new Array(31,29,31,30,31,30,31,31,30,31,30,31);
        tempSmall=inputDate.split("/");
        if(tempSmall.length!=2) { specificError+="Date format not supported"; return false;}
        intSmallM=parseInt(tempSmall[0], 10); intSmallD=parseInt(tempSmall[1], 10);
        if(!(intSmallM>=1 && intSmallM<=12)) { specificError+="Incorrect month, date format is MM/DD"; return false;}
        if(!(intSmallD>=1 && intSmallD<=mDays[intSmallM-1])) { specificError+="Incorrect day, date format is MM/DD"; return false;}
        dateString=String.leftPad(intSmallM, 2, "0")+"/"+String.leftPad(intSmallD, 2, "0");
        modArray__MODULE_ID__+=dateString+";";
        return true;}
      var convertedDate=Date.parse(inputDate);
      var d=new Date();
      var todayDate=d.getTime();
      if(isNaN(convertedDate)){ sError__MODULE_ID__+="Date format not supported"; return false;}
      if(convertedDate>todayDate){ sError__MODULE_ID__+="Date is in the future"; return false;}
      d.setTime(convertedDate);
      dateString=d.getFullYear()+"/"+String.leftPad(d.getMonth() + 1, 2, "0")+"/"+String.leftPad(d.getDate(), 2, "0");
      modArray__MODULE_ID__+=dateString+";";
      return true;}
    
    function testName__MODULE_ID__(inputName){
      if(inputName.indexOf("|")!=-1){ sError__MODULE_ID__+="'|' not allowed in name"; return false;}
      modArray__MODULE_ID__+=inputName+"|"; return true;}
    
    function testArray__MODULE_ID__(inputText){
      sError__MODULE_ID__="<br />";
      var arr=inputText.split("\n");
      for(var i=0; i<arr.length; i++){
        if(arr[i].length==0) continue;
        if(arr[i].indexOf(";")!=arr[i].lastIndexOf(";")){
          sError__MODULE_ID__+="One ';' per line";
          return(errorStr__MODULE_ID__("Incorrect format: "+arr[i]));}
        combo=arr[i].split(";");
        if(!testDate__MODULE_ID__(combo[0])) return(errorStr__MODULE_ID__("Error in line "+(i+1)+": Incorrect Date "+combo[0]));
        if(!testName__MODULE_ID__(combo[1])) return(errorStr__MODULE_ID__("Error in line "+(i+1)+": Incorrect Name "+combo[1]));}
      return true;}
    
    function sortDate__MODULE_ID__(a, b){
      var aA=a.split(";"); var bA=b.split(";");
      var aM=aA[0].split("/"); var bM=bA[0].split("/");
      var ma=aM.length==2?0:1; var mb=bM.length==2?0:1; var da=ma+1; var db=mb+1;
      return aM[ma]>bM[mb]?1:aM[ma]<bM[mb]?-1:aM[da]>bM[db]?1:aM[da]<bM[db]?-1:aA[1]>bA[1]?1:aA[1]<bA[1]?-1:0;}
    
    function sortName__MODULE_ID__(a, b){
      var aA=a.split(";"); var bA=b.split(";");
      var aM=aA[0].split("/"); var bM=bA[0].split("/");
      var ma=aM.length==2?0:1; var mb=bM.length==2?0:1; var da=ma+1; var db=mb+1;
      return aA[1]>bA[1]?1:aA[1]<bA[1]?-1:aM[ma]>bM[mb]?1:aM[ma]<bM[mb]?-1:aM[da]>bM[db]?1:aM[da]<bM[db]?-1:0;}
    
    function sortYear__MODULE_ID__(a, b){
      var aA=a.split(";"); var bA=b.split(";");
      var aM=aA[0].split("/"); var bM=bA[0].split("/");
      var lA=aM.length; var lB=bM.length;
      if(lA<lB) return -1;
      if(lA>lB) return 1;
      var ma=lA==2?0:1; var mb=lB==2?0:1; var da=ma+1; var db=mb+1;
      if(lA==lB && lA==3){ if(aM[0]!=bM[0]) return aM[0]>bM[0]?1:-1}
      return aM[ma]>bM[mb]?1:aM[ma]<bM[mb]?-1:aM[da]>bM[db]?1:aM[da]<bM[db]?-1:aA[1]>bA[1]?1:aA[1]<bA[1]?-1:0;}
    
    function sortArray__MODULE_ID__(){
      if(!save__MODULE_ID__("nosort")) return;
      sortedstr="";
      switch(document.updateForm__MODULE_ID__.sort__MODULE_ID__.value){
        case "Date": sortedarr=myarray.split("|").sort(sortDate__MODULE_ID__); break;
        case "Name": sortedarr=myarray.split("|").sort(sortName__MODULE_ID__); break;
        case "Year": sortedarr=myarray.split("|").sort(sortYear__MODULE_ID__); break;}
      for(var i=0; i<sortedarr.length; i++){ sortedstr+=sortedarr[i]+"|";}
      myarray=sortedstr.substring(0, modArray__MODULE_ID__.length-1);
      prefs__MODULE_ID__.set("birthdays", myarray);}
 
    function save__MODULE_ID__(special){
      if(typeof special == "undefined") special="";
      modArray__MODULE_ID__="";
      var newstr=document.updateForm__MODULE_ID__.updateTextarea__MODULE_ID__.value.trim();
      if(!testArray__MODULE_ID__(newstr)) return false;
      myarray=modArray__MODULE_ID__.substring(0, modArray__MODULE_ID__.length-1);
      if(special=="") sortArray__MODULE_ID__();
      document.updateForm__MODULE_ID__.updateTextarea__MODULE_ID__.value=myarray.replace(/\|/g, "\n");
      prefs__MODULE_ID__.set("birthdays", myarray);
      toggle__MODULE_ID__('On')
      return true;}

    function formatDate__MODULE_ID__(date){
      var month=new Array(12);
        month[0]="__MSG_ajan__";
        month[1]="__MSG_afeb__";
        month[2]="__MSG_amar__";
        month[3]="__MSG_aapr__";
        month[4]="__MSG_amay__";
        month[5]="__MSG_ajun__";
        month[6]="__MSG_ajul__";
        month[7]="__MSG_aaug__";
        month[8]="__MSG_asep__";
        month[9]="__MSG_aoct__";
        month[10]="__MSG_anov__";
        month[11]="__MSG_adec__";
      if(date.length>5) date=date.substr(5);

      return month[parseInt(date.substr(0,2), 10)-1]+ " " + parseInt(date.substr(3,2), 10);}
      
    function confirm__MODULE_ID__(){
      if(saved__MODULE_ID__) setup__MODULE_ID__();
      else if(confirm("All changes will be lost.")) setup__MODULE_ID__();}

    function toggle__MODULE_ID__(direction){
      switch(direction){
        case "Off": document.updateForm__MODULE_ID__.sort__MODULE_ID__.disabled=true; saved__MODULE_ID__=false; break;
        case "On": document.updateForm__MODULE_ID__.sort__MODULE_ID__.disabled=false; saved__MODULE_ID__=true; break;}}
    
    function editMode__MODULE_ID__(passError){
      clearAll__MODULE_ID__();
      if(typeof passError != "undefined") error__MODULE_ID__=passError;
      quick__MODULE_ID__="<a href=\"#\" onClick=\"confirm__MODULE_ID__();\">Back</a>";
      note__MODULE_ID__="Format: YYYY/MM/DD;Name or MM/DD;Name";
      var mainString=prefs__MODULE_ID__.getString("birthdays");
      var numLines=mainString.split("\n").length+1;
      var mainString=mainString.replace(/\|/g, "\n");
      var minLines=5; var maxLines=15;
      var finalLines=numLines>maxLines?maxLines:minLines>numLines?minLines:numLines;
    
      html__MODULE_ID__="<form name=\"updateForm__MODULE_ID__\">";
      html__MODULE_ID__+="<textarea style=\"width: 100%;\" rows=\""+finalLines+"\" name=\"updateTextarea__MODULE_ID__\" onKeyUp=\"toggle__MODULE_ID__('Off')\">"+mainString+"\n</textarea>";
      html__MODULE_ID__+="<input type=\"button\" value=\"Save\" onClick=\"save__MODULE_ID__();\" onKeyPress=\"save__MODULE_ID__();\" />";
      html__MODULE_ID__+=" Sort By: <select name=\"sort__MODULE_ID__\" onChange=\"sortArray__MODULE_ID__()\">";
      html__MODULE_ID__+="<option selected value=\"Date\">Date</option>";
      html__MODULE_ID__+="<option value=\"Name\">Name</option>";
      html__MODULE_ID__+="<option value=\"Year\">Year</option></select></form>";


      _IG_Analytics("UA-310375-4", "/birthday-gadget/edit");
      showAll__MODULE_ID__();
    }
        
    function setup__MODULE_ID__() {
      var tempStr=prefs__MODULE_ID__.getString("birthdays");
      if(tempStr.length==0) {editMode__MODULE_ID__("__MSG_none__"); return;}

      tempArray=tempStr.split("|");
      tempArray.sort(sortName__MODULE_ID__);
      for(var i=0; i<tempArray.length; i++){
        displayArray__MODULE_ID__.push(tempArray[i].split(";"));}

      displayMode__MODULE_ID__();}

    function displayMode__MODULE_ID__(){
      clearAll__MODULE_ID__();
      var year=1000*60*60*24*365;
      quick__MODULE_ID__="<a href=\"#\" onClick=\"editMode__MODULE_ID__();\">Quick Edit</a>";

      html__MODULE_ID__="<table class=\"bdtable\"><tr><th style=\"width: 20%;\">__MSG_tableDate__</th><th style=\"width: 80%;\">__MSG_tableName__</th><th>__MSG_tableAge__</th></tr>";
      var birthdaysVisible=0;
      var warning=prefs__MODULE_ID__.getInt("warning");
      var maxBirthdaysVisible=prefs__MODULE_ID__.getInt("showBDay");
      alert("1");
      for(var i=0; i<warning; i++){
        if(birthdaysVisible>=maxBirthdaysVisible) break;
        var tempDate=new Date;
        var millisec=tempDate.getTime();
        tempDate.setTime(millisec+i*1000*60*60*24);
        iDate=String.leftPad(tempDate.getMonth() + 1, 2, "0")+"/"+String.leftPad(tempDate.getDate(), 2, "0");
      alert("2"+displayArray__MODULE_ID__.length);
        for(var j=0; j<displayArray__MODULE_ID__.length; j++){
          jDate=(displayArray__MODULE_ID__[j][0].length>5)?displayArray__MODULE_ID__[j][0].substr(5):displayArray__MODULE_ID__[j][0];
          debug__MODULE_ID__+=i+") "+iDate+" --> "+jDate+"<br />";
          if(birthdaysVisible>=prefs__MODULE_ID__.getInt("showBDay")) break;
          if(jDate==iDate){
      alert("3");
            birthdaysVisible++;
            var age="";
            if(displayArray__MODULE_ID__[j][0].length>5){
              var d = new Date();
              var b = Date.parse(displayArray__MODULE_ID__[j][0]);
              age=Math.floor((d-b)/year);
              if(age==0){ age=Math.floor(((d-b)/year)*12); age=age==0?"<1M":age+"M";}
            html__MODULE_ID__+="<tr><td>"+formatDate__MODULE_ID__(displayArray__MODULE_ID__[j][0]);
            html__MODULE_ID__+="</td><td>"+displayArray__MODULE_ID__[j][1]+"</td><td>"+age+"</td></tr>";}}}}
      html__MODULE_ID__+="</table>";
      
      if(birthdaysVisible==0) html__MODULE_ID__="__MSG_nobd1__ "+warning+" __MSG_nobd2__";
      
      _IG_Analytics("UA-310375-4", "/birthday-gadget/display");
      showAll__MODULE_ID__();}

    function clearAll__MODULE_ID__(){
      displayArray__MODULE_ID__=new Array();
      quick__MODULE_ID__="";
      error__MODULE_ID__="";
      debug__MODULE_ID__=""; //debug only
      note__MODULE_ID__="";
      html__MODULE_ID__="";}

    function showAll__MODULE_ID__(){
      _gel("quick__MODULE_ID__").innerHTML=quick__MODULE_ID__;
      _gel("error__MODULE_ID__").innerHTML=error__MODULE_ID__;
      _gel("debug__MODULE_ID__").innerHTML=debug__MODULE_ID__; //debug only
      _gel("note__MODULE_ID__").innerHTML=note__MODULE_ID__;
      _gel("table__MODULE_ID__").innerHTML=html__MODULE_ID__;
      _IG_AdjustIFrameHeight();}


    _IG_RegisterOnloadHandler(setup__MODULE_ID__);


  </script>
  <div id="quick__MODULE_ID__"></div>
  <div id="error__MODULE_ID__"></div>
  <div id="debug__MODULE_ID__"></div>
  <div id="note__MODULE_ID__"></div>
  <div id="table__MODULE_ID__"></div>

]]></Content>
</Module>
