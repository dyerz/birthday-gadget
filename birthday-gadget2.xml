<?xml version="1.0" encoding="UTF-8"?>
<Module>
<ModulePrefs title="__UP_title__"
  directory_title="__MSG_title__"
  description="__MSG_description__"
  screenshot="http://birthday-gadget.googlecode.com/svn/trunk/screenshot.png"
  thumbnail="http://birthday-gadget.googlecode.com/svn/trunk/thumbnail.png"
  author="Adam"
  author_email="birthdaygadget@gmail.com"
  height="200">
    <Locale messages="http://birthday-gadget.googlecode.com/svn/trunk/bd_content/ALL_ALL.xml" />
    <Locale lang="de" messages="http://birthday-gadget.googlecode.com/svn/trunk/bd_content/de_ALL.xml" />
    <Locale lang="es" messages="http://birthday-gadget.googlecode.com/svn/trunk/bd_content/es_ALL.xml" />
    <Locale lang="fr" messages="http://birthday-gadget.googlecode.com/svn/trunk/bd_content/fr_ALL.xml" />
    <Locale lang="it" messages="http://birthday-gadget.googlecode.com/svn/trunk/bd_content/it_ALL.xml" />
    <Locale lang="ko" messages="http://birthday-gadget.googlecode.com/svn/trunk/bd_content/ko_ALL.xml" />
    <Locale lang="nl" messages="http://birthday-gadget.googlecode.com/svn/trunk/bd_content/nl_ALL.xml" />
    <Locale lang="pt-PT" messages="http://birthday-gadget.googlecode.com/svn/trunk/bd_content/pt_ALL.xml" />
    <Locale lang="pt-BR" messages="http://birthday-gadget.googlecode.com/svn/trunk/bd_content/pt_br_ALL.xml" />
    <Locale lang="ru" messages="http://birthday-gadget.googlecode.com/svn/trunk/bd_content/ru_ALL.xml" />
    <Locale lang="sv" messages="http://birthday-gadget.googlecode.com/svn/trunk/bd_content/sv_ALL.xml" />
    <Require feature="idi" /> 
    <Require feature="locked-domain" /> 
    <Require feature="analytics" /> 
    <Require feature="dynamic-height" />
    <Require feature="setprefs"/>
	<Require feature="drag" /> 
</ModulePrefs>
<UserPref name="title" display_name="__MSG_titleName__" default_value="__MSG_title__" />
<UserPref name="birthdays" datatype="hidden" default_value="" /> 
<UserPref name="dateFormat" display_name="__MSG_formatName__" default_value="0" datatype="enum" >
  <EnumValue value="0" display_value="MMM DD" />
  <EnumValue value="1" display_value="DD MMM" />
  <EnumValue value="2" display_value="MM/DD" />
  <EnumValue value="3" display_value="DD/MM" />
</UserPref>
<UserPref name="showBDay" display_name="__MSG_showName__" default_value="5" datatype="enum" >
  <EnumValue value="1" />
  <EnumValue value="2" />
  <EnumValue value="3" />
  <EnumValue value="4" />
  <EnumValue value="5" />
  <EnumValue value="6" />
  <EnumValue value="7" />
  <EnumValue value="8" />
  <EnumValue value="9" />
  <EnumValue value="10" />
  <EnumValue value="20" />
  <EnumValue value="0" display_value="__MSG_noticeAll__" />
</UserPref>
<UserPref name="warnForward" display_name="__MSG_futureNoticeName__" default_value="7" datatype="enum" >
  <EnumValue value="3" />
  <EnumValue value="7" />
  <EnumValue value="10" />
  <EnumValue value="14" />
  <EnumValue value="21" />
  <EnumValue value="30" />
  <EnumValue value="60" />
  <EnumValue value="90" /> 
  <EnumValue value="0" display_value="__MSG_noticeAll__" /> 
</UserPref>
<UserPref name="warnPast" display_name="__MSG_pastNoticeName__" default_value="0" datatype="enum" >
  <EnumValue value="0" display_value="__MSG_noticeNone__"/>
  <EnumValue value="3" />
  <EnumValue value="7" />
  <EnumValue value="10" />
  <EnumValue value="14" />
</UserPref>
<UserPref name="showAge" display_name="__MSG_showAge__" default_value="true" datatype="bool" />
<UserPref name="showDays" display_name="__MSG_showDays__" default_value="false" datatype="bool" />
<UserPref name="showZodiac" display_name="__MSG_showZodiac__" default_value="false" datatype="bool" />
<UserPref name="fontColor" default_value="#000000" datatype="hidden" />
<UserPref name="bgColor" default_value="#FFFFFF" datatype="hidden" />
<UserPref name="fontSize" default_value="small" datatype="hidden" />
<UserPref name="_table_query_url" datatype="hidden" /> 
<UserPref name="tbVis" default_value="false" datatype="hidden" /> 
<UserPref name="tbOrder" default_value="12345" datatype="hidden" /> 

<Content type="html">
<![CDATA[ 
<style>
	/* Toolbar CSS */
	#toolbar{ height: 12px; text-align: center; margin: 0; padding: 0; width: 100%;}
	#toolbar table{ border-collapse: collapse; padding: 0; margin: 0; text-align: center; width: 100%;}
	#toolbar td{ padding: 0; margin: 0; font-size: 10px;}
	#tbConfig{ width: 20%; text-align: left; color: #0000FF; text-decoration: underline; cursor: pointer;}
	#tbConvert{	width: 30%;	color: #FF0000;	text-decoration: underline;	cursor: pointer;}
	#tbRefresh{	width: 20%;	cursor: pointer; color: #0000FF; text-decoration: underline; text-align: right;}
	
	/* Toolbar Vis CSS */
	#toolbarVis{ position: relative; margin: 6px 0 0 0; padding: 0;	width: 100%; height: 3px; background-color: #666666; cursor: n-resize; text-align: center;}
	#toolbarVis img{ border: none; margin: 0 auto; padding: 0;}
	#upImg{ position: absolute; top: -5px;}
	#dnImg{ position: absolute; bottom: -6px;}	

	/* Table Div CSS */
	#tablediv{ width: 100%; margin: 10px 0 0 0; padding: 0;}
	#tablediv table { border-collapse: collapse; width: 100%;}
	#tablediv td { background-color: inherit; padding: 2px;}
	#tablediv tr{ background-color: inherit;}
	#dataTable td{ text-align: center;}
	.colid { font-weight: bold; border-bottom: 1px solid #000000; text-align: center; cursor: move;}

	/* Font Size CSS */
	.xsmall{ font-size: 10px;}
	.small{ font-size: 11px;}
	.medium{ font-size: 12px;}
	.large{ font-size: 14px;}
	.xlarge{ font-size: 16px;}

	/* Config Table CSS */
	#configTable{ width: 100%;}
	#configTable div{width: 100%;}
	#configTable td{font-size: 11px;}
	#shUrl{width: 100%;}		
	.configTitle{text-align: left; width: 30%;}
	.configText{ text-align: left; width: 70%;}

	/* Misc CSS */
	h1{font-size: 22px; text-align: center;}
	.error{color: #FF0000;}
	#oldtxt{width: 100%;height: 100px;}
	.left{text-align: left;}
	.exampleSpan{padding-right: 25px;border: 1px solid #DDDDDD;}
	.highlight{background-color: #FFFF99; width: 100%; color: #000000;}
</style>
<script src="http://www.google.com/jsapi" type="text/javascript"></script>

<div id="toolbar" style="display: none;"></div><div id="toolbarVis">
<img id="upImg" style="display: none;" src="http://birthday-gadget.googlecode.com/svn/trunk/bd_content/up.png" height="4" width="12" />
<img id="dnImg" style="display: none;" src="http://birthday-gadget.googlecode.com/svn/trunk/bd_content/dn.png" height="4" width="12" />
</div><div id="tablediv" >__MSG_Loading__...</div><div id="colorpicker201" class="colorpicker201"></div>

<script>
    google.load("visualization", "1");
	var prefs__MODULE_ID__, prefArr__MODULE_ID__=new Object();
	var tableDivObj__MODULE_ID__, dataArray__MODULE_ID__;
    
	//get started
    function init__MODULE_ID__(){
		var prefNames=new Array("dateFormat", "showBDay", "warnForward", "warnPast", "showAge", "showDays",
			"showZodiac", "_table_query_url", "tbVis", "birthdays", "fontSize", "fontColor", "bgColor", "tbOrder");
		prefs__MODULE_ID__ = new _IG_Prefs();
		tableDivObj__MODULE_ID__=_gel('tablediv');
		tableDivObj__MODULE_ID__.innerHTML ="__MSG_Loading__..."; 
		//get prefs
		for(var i=0; i<prefNames.length; i++){
			switch(prefNames[i]){
				case "dateFormat":
				case "showBDay":
				case "warnForward":
				case "warnPast":
					prefArr__MODULE_ID__[prefNames[i]]=prefs__MODULE_ID__.getInt(prefNames[i]); break;
				case "showAge":
				case "showDays":
				case "showZodiac":
					prefArr__MODULE_ID__[prefNames[i]]=prefs__MODULE_ID__.getBool(prefNames[i]); break;
				default:
					prefArr__MODULE_ID__[prefNames[i]]=prefs__MODULE_ID__.getString(prefNames[i]);
			}
		}
		
		/*** DEBUG 
		if(prefs__MODULE_ID__.getBool("debugMe")){
			prefArr__MODULE_ID__["_table_query_url"]="";
			prefs__MODULE_ID__.set("_table_query_url", "");
			prefArr__MODULE_ID__["birthdays"]="2008/08/12\tName";
			prefs__MODULE_ID__.set("birthdays", prefArr__MODULE_ID__["birthdays"]);
			prefs__MODULE_ID__.set("debugMe", false);
		}
		***/
		
		//queryurl check
		if(prefArr__MODULE_ID__["_table_query_url"]=="") {showHelp__MODULE_ID__(); return;}
		//toolbar creation
		buildToolbar__MODULE_ID__();
		flipTB__MODULE_ID__(false);
		//init done.. show stuff
		sendQuery__MODULE_ID__();
    }

/* Toolbar functions ***************************/
	function buildToolbar__MODULE_ID__(){
		var html = [];
		html.push('<table><tr><td id="tbConfig">__MSG_tbConfig__</td>');
		if(prefArr__MODULE_ID__["birthdays"]!="") html.push('<td id="tbConvert">__MSG_tbConvert__</td>');
		html.push('<td id="tbHelp"><a href="http://birthday-gadget.googlecode.com/svn/trunk/faq.html" title="__MSG_tbHelp__" target="_blank">__MSG_tbHelp__</a></td>');
		html.push('<td id="tbRefresh">__MSG_tbRefresh__</td></tr></table>');	
		_gel('toolbar').innerHTML = html.join('');
		
		//toolbar actions
		_gel("tbConfig").onclick=function(){ tableDivObj__MODULE_ID__.innerHTML ="__MSG_Loading__..."; goConfig__MODULE_ID__();};
		if(prefArr__MODULE_ID__["birthdays"]!="") _gel("tbConvert").onclick=function(){ tableDivObj__MODULE_ID__.innerHTML ="__MSG_Loading__..."; goConvert__MODULE_ID__();}
		_gel("tbRefresh").onclick=function(){ tableDivObj__MODULE_ID__.innerHTML ="__MSG_Loading__..."; sendQuery__MODULE_ID__();};

		//js event config
		_gel("toolbarVis").onclick=function(){
			prefArr__MODULE_ID__["tbVis"]=prefArr__MODULE_ID__["tbVis"]=="true"?"false":"true";
			prefs__MODULE_ID__.set("tbVis", prefArr__MODULE_ID__["tbVis"]);
			flipTB__MODULE_ID__(true);
		};
	}
	
	function flipTB__MODULE_ID__(sh){
		if(prefArr__MODULE_ID__["tbVis"]=="false"){
			_gel("toolbarVis").title="__MSG_tbHide__";
			_gel("toolbar").style.display=""; _gel("upImg").style.display=""; _gel("dnImg").style.display="none";
		} else {
			_gel("toolbarVis").title="__MSG_tbShow__";
			_gel("toolbar").style.display="none"; _gel("upImg").style.display="none"; _gel("dnImg").style.display="";
		}
		if(sh) _IG_AdjustIFrameHeight();
	}

/* Data Functions ******************************/	
    function sendQuery__MODULE_ID__(qCheck) {
		if(prefArr__MODULE_ID__["_table_query_url"].search(/tq\?/)==-1 ){
			prefArr__MODULE_ID__["_table_query_url"]=prefArr__MODULE_ID__["_table_query_url"].replace(/ccc\?/, "tq?").replace(/pub\?/, "tq?");
			if(prefArr__MODULE_ID__["_table_query_url"].search(/\&/)!=-1)
				prefArr__MODULE_ID__["_table_query_url"]=prefArr__MODULE_ID__["_table_query_url"].substring(0, prefArr__MODULE_ID__["_table_query_url"].indexOf("&"));
			prefArr__MODULE_ID__["_table_query_url"]=escapeHtml__MODULE_ID__(prefArr__MODULE_ID__["_table_query_url"])
			prefs__MODULE_ID__.set("_table_query_url", prefArr__MODULE_ID__["_table_query_url"]);
		}

		var query=new google.visualization.Query(prefArr__MODULE_ID__["_table_query_url"]);
		query.setQuery("select * format A 'yyyy/MM/dd'");
		query.send(handleQueryResponse__MODULE_ID__);
	}

    function handleQueryResponse__MODULE_ID__(response) {
		if(response.isError()) {
			switch(response.getReasons()){
				case "access_denied": goError__MODULE_ID__('__MSG_errAccess__<br />__MSG_errLogin__'); break;
				case "timeout": goError__MODULE_ID__('__MSG_errTimeout__<br />__MSG_errRefresh__'); break;
				case "invalid_query": goError__MODULE_ID__('__MSG_errSheet__<br />__MSG_errNoData__'); break;
				default: goError__MODULE_ID__('__MSG_errUnk__: '+response.getDetailedMessage()+'<br />__MSG_errNoData__');
			}
			return;
		}
		var data = response.getDataTable(), html=[];

		//check for dates
		if(data.getColumnType(1)=="date"){ goError__MODULE_ID__('__MSG_errColumn__'); return; }
		if(data.getColumnType(0)!="date"){ goError__MODULE_ID__('__MSG_errDateFormat__'); return; }
		if(data.getNumberOfRows()==0 || data.getNumberOfColumns()==0){ goError__MODULE_ID__('__MSG_errNoData__'); return; }
		
		dataArray__MODULE_ID__=buildArray__MODULE_ID__(data);
		if(dataArray__MODULE_ID__.length==0){
			html.push('<div class="'+prefArr__MODULE_ID__["fontSize"]+'" style="width: 100%; color: '+prefArr__MODULE_ID__["fontColor"]+'; background-color: '+prefArr__MODULE_ID__["bgColor"]+';">');
			html.push('__MSG_noBirthdays1__ '+prefArr__MODULE_ID__["warnForward"]+' __MSG_noBirthdays2__</div>');
			tableDivObj__MODULE_ID__.style.textAlign="center";
			tableDivObj__MODULE_ID__.innerHTML = html.join('');
			_IG_AdjustIFrameHeight(); return;
		}
		
		buildTable__MODULE_ID__();
		_IG_AdjustIFrameHeight();
	}
	
	function buildTable__MODULE_ID__(){
		var html=[], rowDate, dispAge=0, dispDate="", dispDays=0, countDisp=1;
		
		html.push('<table id="dataTable" style="color: '+prefArr__MODULE_ID__["fontColor"]+'; background-color: '+prefArr__MODULE_ID__["bgColor"]+';">');

		// Header row for column Ids
		var headerStr=' class="colid '+prefArr__MODULE_ID__["fontSize"]+'" style="border-color: '+prefArr__MODULE_ID__["fontColor"]+';"';
		html.push('<tr>');
		
		var order=prefArr__MODULE_ID__["tbOrder"].split(""), step;
		for(step=0; step<order.length; step++){
			switch(parseInt(order[step],10)){
				case 1: html.push('<td'+headerStr+' id="thHead1">__MSG_tableDate__</td>'); break;
				case 2: html.push('<td'+headerStr+' id="thHead2">__MSG_tableName__</td>'); break;
				case 3: if(prefArr__MODULE_ID__["showAge"]) html.push('<td'+headerStr+' id="thHead3">__MSG_tableAge__</td>'); break;
				case 4: if(prefArr__MODULE_ID__["showDays"]) html.push('<td'+headerStr+' id="thHead4">__MSG_tableDays__</td>'); break;
				case 5: if(prefArr__MODULE_ID__["showZodiac"]) html.push('<td'+headerStr+' id="thHead5">__MSG_tableZodiac__</td>'); break;
			}
		}
		html.push('</tr>');

		dispLength=prefArr__MODULE_ID__["showBDay"]==0?dataArray__MODULE_ID__.length:prefArr__MODULE_ID__["showBDay"];

		// Add the data rows
		for (var row = 0; row < dataArray__MODULE_ID__.length; row++) {
			var rowData=dataArray__MODULE_ID__[row].split("~;~");
			rowDate=Date.parse(rowData[0]);

			html.push('<tr>');
			for(step=0; step<order.length; step++){
				switch(parseInt(order[step],10)){
					case 1: html.push('<td class="'+prefArr__MODULE_ID__["fontSize"]+'">'+makeDate__MODULE_ID__(rowData[0])+'</td>'); break;
					case 2: html.push('<td class="'+prefArr__MODULE_ID__["fontSize"]+'">'+escapeHtml__MODULE_ID__(rowData[1])+'</td>'); break;
					case 3: if(prefArr__MODULE_ID__["showAge"]) html.push('<td class="'+prefArr__MODULE_ID__["fontSize"]+'">'+makeAge__MODULE_ID__(rowDate, rowData[2])+'</td>'); break;
					case 4: if(prefArr__MODULE_ID__["showDays"]) html.push('<td class="'+prefArr__MODULE_ID__["fontSize"]+'">'+makeDays__MODULE_ID__(rowData[2])+'</td>'); break;
					case 5: if(prefArr__MODULE_ID__["showZodiac"]) html.push('<td class="'+prefArr__MODULE_ID__["fontSize"]+'">'+makeZodiac__MODULE_ID__(rowData[2])+'</td>'); break;
				}
			}
			html.push('</tr>');
			if(countDisp++>=dispLength) break;
		}
		_IG_Analytics("UA-310375-4", "/birthday-gadget/display");	
		html.push('</table>');
		tableDivObj__MODULE_ID__.innerHTML = html.join('');
		dragging__MODULE_ID__();	
	}

	function dragging__MODULE_ID__(){
		var moveIt = new _IG_Drag(), currentSource=null;
		
		moveIt.addSource("thHead1"); moveIt.addTarget("thHead1");
		moveIt.addSource("thHead2"); moveIt.addTarget("thHead2");
		if(prefArr__MODULE_ID__["showAge"]) { moveIt.addSource("thHead3"); moveIt.addTarget("thHead3");}
		if(prefArr__MODULE_ID__["showDays"]) { moveIt.addSource("thHead4"); moveIt.addTarget("thHead4");}
		if(prefArr__MODULE_ID__["showZodiac"]) { moveIt.addSource("thHead5"); moveIt.addTarget("thHead5");}
	
		var origObj=new Array(
			'<div class="highlight">** Swap **</div>',
			_gel('thHead1').innerHTML,
			_gel('thHead2').innerHTML,
			_gel('thHead3').innerHTML,
			_gel('thHead4').innerHTML,
			_gel('thHead5').innerHTML
		);
		
		moveIt.onDragStart=function(object){currentSource=object};
		moveIt.onDragTargetHit=function(object, old_object) {
			moveIt.onDragTargetLost(old_object);
			if (object != currentSource){object.innerHTML = origObj[0];}
		};
		moveIt.onDragTargetLost=function(object){
			if(object == null) {return;}
			object.innerHTML=origObj[parseInt(object.id.substring(6), 10)];
		};
		moveIt.onDragEnd=function(source, target){
			if(target==null) return;
			var src=source.id.substring(6), tar=target.id.substring(6), srcRE = new RegExp(src), tarRE = new RegExp(tar);
			var tempOrder=prefArr__MODULE_ID__["tbOrder"].replace(src,"x").replace(tar,"y");
			prefArr__MODULE_ID__["tbOrder"]=tempOrder.replace(/x/, tar).replace(/y/, src);
			prefs__MODULE_ID__.set("tbOrder", prefArr__MODULE_ID__["tbOrder"]);
			buildTable__MODULE_ID__();
		};
	}
	
	function buildArray__MODULE_ID__(data){
		var dataArray=new Array(), dataDate, tempDate=new Date(), nowDate=new Date(), maxDate=new Date(), formatDate="", tempData;
		nowDate.setTime(nowDate.getTime()-prefArr__MODULE_ID__["warnPast"]*86400000);
		maxDate.setTime(maxDate.getTime()+prefArr__MODULE_ID__["warnForward"]*86400000);
		for(var row=0; row<data.getNumberOfRows(); row++){
			dataDate=data.getFormattedValue(row,0);
			if(dataDate=="") continue;
			tempData=Date.parse(dataDate);
			if(isNaN(tempData)) { alert("Date Error: Row Number "+row); continue;}
			tempDate.setTime(tempData);
			if(tempDate.getMonth()<nowDate.getMonth() ||
				(tempDate.getMonth()==nowDate.getMonth()&&tempDate.getDate()<nowDate.getDate()))
				tempDate.setFullYear(nowDate.getFullYear()+1);
			else tempDate.setFullYear(nowDate.getFullYear());
			if(tempDate.getTime()>maxDate.getTime() && prefArr__MODULE_ID__["warnForward"]!=0) continue;
			formatDate=tempDate.getFullYear()+"/"+(tempDate.getMonth()+1)+"/"+tempDate.getDate();
			dataArray.push(dataDate+"~;~"+data.getFormattedValue(row,1)+"~;~"+formatDate);
		}
		dataArray=dataArray.sort(sortDate__MODULE_ID__);
		return(dataArray);
	}

	function sortDate__MODULE_ID__(a, b){
		var aA=a.split("~;~"), bA=b.split("~;~"); return Date.parse(aA[2])-Date.parse(bA[2]);
	}	

    function makeDate__MODULE_ID__(inDate){
		var month=new Array("__MSG_ajan__", "__MSG_afeb__", "__MSG_amar__", "__MSG_aapr__", "__MSG_amay__", "__MSG_ajun__", "__MSG_ajul__", "__MSG_aaug__", "__MSG_asep__", "__MSG_aoct__", "__MSG_anov__", "__MSG_adec__");
		var tempArr=inDate.split("/"), m=parseInt(tempArr[1], 10), d=tempArr[2], n=new Date();
		if(n.getMonth()+1==m && n.getDate()==d ) return("__MSG_today__");
		switch(prefArr__MODULE_ID__["dateFormat"]){
			case 0: return (month[m-1]+" "+d);
			case 1: return (d+" "+month[m-1]);
			case 2: return (m+"/"+d);
			case 3: return (d+"/"+m);
		}
	}

    function makeAge__MODULE_ID__(rowDate, formatDate){var n=new Date(), b=new Date();
		n.setTime(Date.parse(formatDate)); b.setTime(rowDate); return n.getFullYear()-b.getFullYear();
	}
    
	function makeDays__MODULE_ID__(formatDate){
		var t=new Date();
		return Math.round((Date.parse(formatDate)-Date.parse(t.getFullYear()+"/"+(t.getMonth()+1)+"/"+t.getDate()))/(86400000));
	}
	
	function makeZodiac__MODULE_ID__(formatDate){
		var s=formatDate.split("/");
		s[1]=parseInt(s[1],10); s[2]=parseInt(s[2],10);
		switch(s[1]){
			case 1: return (s[2]<21?"__MSG_zCapricorn__":"__MSG_zAquarius__");
			case 2: return (s[2]<19?"__MSG_zAquarius__":"__MSG_zPisces__");
			case 3: return (s[2]<21?"__MSG_zPisces__":"__MSG_zAries__");
			case 4: return (s[2]<21?"__MSG_zAries__":"__MSG_zTaurus__");
			case 5: return (s[2]<22?"__MSG_zTaurus__":"__MSG_zGemini__");
			case 6: return (s[2]<22?"__MSG_zGemini__":"__MSG_zCancer__");
			case 7: return (s[2]<23?"__MSG_zCancer__":"__MSG_zLeo__");
			case 8: return (s[2]<22?"__MSG_zLeo__":"__MSG_zVirgo__");
			case 9: return (s[2]<24?"__MSG_zVirgo__":"__MSG_zLibra__");
			case 10: return (s[2]<24?"__MSG_zLibra__":"__MSG_zScorpio__");
			case 11: return (s[2]<23?"__MSG_zScorpio__":"__MSG_zSagittarius__");
			case 12: return (s[2]<23?"__MSG_zSagittarius__":"__MSG_zCapricorn__");
		}
	}	
	
/* General Functions ***************************/
    function escapeHtml__MODULE_ID__(text) {
		if (text == null) { return ''; }
		return text.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;');
    }

/* Help / Error Functions **********************/
	function showHelp__MODULE_ID__(){
		_IG_Analytics("UA-310375-4", "/birthday-gadget/setup");	
		var html = [];
		html.push('<h1>__MSG_setupH1__</h1>');
		if(prefArr__MODULE_ID__["birthdays"]!="") html.push('__MSG_setupGreet1__<br />__MSG_setupGreet2__<br />__MSG_setupGreet3__');
		html.push('<ol><li><a href="http://docs.google.com/" target="_blank">__MSG_setupStep1__</a></li>');
		html.push('<li>__MSG_setupStep2__');
		if(prefArr__MODULE_ID__["birthdays"]!="") html.push('<br />__MSG_setupStep2P__');
		html.push('</li><li>__MSG_setupStep3__</li><li>__MSG_setupStep4__</li>');
		html.push('<li>__MSG_setupStep5__<br /><input type="text" style="width: 100%" id="newurl" />');
		html.push('<br /><input type="button" value="__MSG_configSave__" id="saveurl" /></li></ol>');
		html.push('<a href="http://birthday-gadget.googlecode.com/svn/trunk/faq.html" title="FAQ" target="_blank">__MSG_setupMore__</a>');
	
		tableDivObj__MODULE_ID__.innerHTML = html.join('');
		_gel('saveurl').onclick=function(){
			var tempStr=_trim(_gel('newurl').value);
			if(!urlCheck__MODULE_ID__(tempStr)) return;
			prefArr__MODULE_ID__["_table_query_url"]=escapeHtml__MODULE_ID__(tempStr)
			prefs__MODULE_ID__.set("_table_query_url", prefArr__MODULE_ID__["_table_query_url"]);
			tableDivObj__MODULE_ID__.innerHTML ="__MSG_Loading__...";
			init__MODULE_ID__();
		}

		_IG_AdjustIFrameHeight();
	}

	function goError__MODULE_ID__(errText){
		_IG_Analytics("UA-310375-4", "/birthday-gadget/error");	
		var moreErr=[];
		moreErr.push('<h1>__MSG_errH1__</h1><span class="error">'+errText+'</span>');
		moreErr.push('<br /><a href="http://birthday-gadget.googlecode.com/svn/trunk/faq.html" title="Help" target="_blank">__MSG_errMore__</a>');
		moreErr.push('<br />__MSG_errCommon__');
		tableDivObj__MODULE_ID__.innerHTML = moreErr.join('');
		_IG_AdjustIFrameHeight();
	}	

/* Config Page Functions ***********************/	
	function goConfig__MODULE_ID__(){
		_IG_Analytics("UA-310375-4", "/birthday-gadget/config");	
		var html=[];
		html.push('<h1>__MSG_tbConfig__</h1><table id="configTable">');
		html.push('<tr><td colspan="2" class="left"><a target="_blank" href="'+prefArr__MODULE_ID__["_table_query_url"].replace(/tq\?/, "ccc?")+'">__MSG_configEdit__</a></td></tr>'); 
		html.push('<tr><td class="configTitle">__MSG_configFontColor__</td><td class="configText"><input id="textSet" type="button" value="__MSG_configPick__" /> ');
		html.push('<input id="textDiv" type="text" value="'+prefArr__MODULE_ID__["fontColor"]+'" /> ');
		html.push('<span id="textSpan" class="exampleSpan" style="background-color: '+prefArr__MODULE_ID__["fontColor"]+'">&nbsp</span></td></tr>'); 
		html.push('<tr><td class="configTitle">__MSG_configBGColor__</td><td class="configText"><input id="bgcSet" type="button" value="__MSG_configPick__" /> ');
		html.push('<input id="bgcDiv" type="text" value="'+prefArr__MODULE_ID__["bgColor"]+'" /> ');
		html.push('<span id="bgcSpan" class="exampleSpan" style="background-color: '+prefArr__MODULE_ID__["bgColor"]+'">&nbsp</span></td></tr>'); 
		html.push('<tr><td class="configTitle">__MSG_configFontSize__</td><td class="configText">'+makeFontSize__MODULE_ID__()+'</td></tr>'); 
		html.push('<tr><td class="configTitle">__MSG_configURL__</td><td class="configText"><textarea id="shUrl" rows="1">'+prefArr__MODULE_ID__["_table_query_url"]+'</textarea></td></tr>'); 
		html.push('</table><table style="margin: 0; padding: 0; text-align: center;">');
		html.push('<tr><td><input id="configBack" type="button" value="__MSG_configBack__" /></td>');
		html.push('<td><input id="configSave" type="button" value="__MSG_configSave__" /></td></tr>'); 
		html.push('</table>');
		
		tableDivObj__MODULE_ID__.innerHTML = html.join('');	
		_gel('textSet').onclick=function(){ showColorGrid2__MODULE_ID__("textDiv","textSpan");_IG_AdjustIFrameHeight();}
		_gel('bgcSet').onclick=function(){ showColorGrid2__MODULE_ID__("bgcDiv","bgcSpan");_IG_AdjustIFrameHeight();}
		_gel('configBack').onclick=function(){ 
			if(!configChanged__MODULE_ID__() || confirm("__MSG_configConfirm__"))  sendQuery__MODULE_ID__();}
		_gel('configSave').onclick=function(){if(configSave__MODULE_ID__()) sendQuery__MODULE_ID__();}
		_IG_AdjustIFrameHeight();
	}
	
	function getScrollY__MODULE_ID__(){var scrOfX = 0,scrOfY=0;if(typeof(window.pageYOffset)=='number'){scrOfY=window.pageYOffset;scrOfX=window.pageXOffset;}else if(document.body&&(document.body.scrollLeft||document.body.scrollTop)){scrOfY=document.body.scrollTop;scrOfX=document.body.scrollLeft;}else if(document.documentElement&&(document.documentElement.scrollLeft||document.documentElement.scrollTop)){scrOfY=document.documentElement.scrollTop;scrOfX=document.documentElement.scrollLeft;}return scrOfY;}document.write("<style type='text/css'>.colorpicker201{visibility:hidden;display:none;position:absolute;background:#FFF;border:solid 1px #CCC;padding:4px;z-index:999;filter:progid:DXImageTransform.Microsoft.Shadow(color=#D0D0D0,direction=135);}.o5582brd{padding:0;width:12px;height:14px;border-bottom:solid 1px #DFDFDF;border-right:solid 1px #DFDFDF;}a.o5582n66,.o5582n66,.o5582n66a{font-family:arial,tahoma,sans-serif;text-decoration:underline;font-size:9px;color:#666;border:none;}.o5582n66,.o5582n66a{text-align:center;text-decoration:none;}a:hover.o5582n66{text-decoration:none;color:#FFA500;cursor:pointer;}.a01p3{padding:1px 4px 1px 2px;background:whitesmoke;border:solid 1px #DFDFDF;}</style>");function getTop2__MODULE_ID__(){csBrHt=0;if(typeof(window.innerWidth)=='number'){csBrHt=window.innerHeight;}else if(document.documentElement&&(document.documentElement.clientWidth||document.documentElement.clientHeight)){csBrHt=document.documentElement.clientHeight;}else if(document.body&&(document.body.clientWidth||document.body.clientHeight)){csBrHt=document.body.clientHeight;}ctop=((csBrHt/2)-115)+getScrollY__MODULE_ID__();return ctop;}var nocol1="&#78;&#79;&#32;&#67;&#79;&#76;&#79;&#82;",clos1="&#67;&#76;&#79;&#83;&#69;",tt2="&#70;&#82;&#69;&#69;&#45;&#67;&#79;&#76;&#79;&#82;&#45;&#80;&#73;&#67;&#75;&#69;&#82;&#46;&#67;&#79;&#77;",hm2="&#104;&#116;&#116;&#112;&#58;&#47;&#47;&#119;&#119;&#119;&#46;";hm2+=tt2;tt2="&#80;&#79;&#87;&#69;&#82;&#69;&#68;&#32;&#98;&#121;&#32;&#70;&#67;&#80;";function getLeft2__MODULE_ID__(){var csBrWt=0;if(typeof(window.innerWidth)=='number'){csBrWt=window.innerWidth;}else if(document.documentElement&&(document.documentElement.clientWidth||document.documentElement.clientHeight)){csBrWt=document.documentElement.clientWidth;}else if(document.body&&(document.body.clientWidth||document.body.clientHeight)){csBrWt=document.body.clientWidth;}cleft=(csBrWt/2)-125;return cleft;}function setCCbldID2__MODULE_ID__(objID,val){document.getElementById(objID).value=val;}function setCCbldSty2__MODULE_ID__(objID,prop,val){switch(prop){case "bc":if(objID!='none'){document.getElementById(objID).style.backgroundColor=val;};break;case "vs":document.getElementById(objID).style.visibility=val;break;case "ds":document.getElementById(objID).style.display=val;break;case "tp":document.getElementById(objID).style.top=val;break;case "lf":document.getElementById(objID).style.left=val;break;}}function putOBJxColor2__MODULE_ID__(OBjElem,Samp,pigMent){if(pigMent!='x'){setCCbldID2__MODULE_ID__(OBjElem,pigMent);setCCbldSty2__MODULE_ID__(Samp,'bc',pigMent);}setCCbldSty2__MODULE_ID__('colorpicker201','vs','hidden');setCCbldSty2__MODULE_ID__('colorpicker201','ds','none');}function showColorGrid2__MODULE_ID__(OBjElem,Sam){var objX=new Array('00','33','66','99','CC','FF');var c=0;var z='"'+OBjElem+'","'+Sam+'",""';var xl='"'+OBjElem+'","'+Sam+'","x"';var mid='';mid+='<table bgcolor="#FFFFFF" border="0" cellpadding="0" cellspacing="0" style="border:solid 0px #F0F0F0;padding:2px;"><tr>';mid+="<td colspan='18' align='left' style='font-size:10px;background:#6666CC;color:#FFF;font-family:arial;'>&nbsp;Chromatic Selection Palette</td></tr><tr><td colspan='18' align='center' style='margin:0;padding:2px;height:12px;' ><input class='o5582n66' type='text' size='12' id='o5582n66' value='#FFFFFF'><input class='o5582n66a' type='text' size='2' style='width:14px;' id='o5582n66a' onclick='javascript:alert(\"click on selected swatch below...\");' value='' style='border:solid 1px #666;'>&nbsp;|&nbsp;<a class='o5582n66' href='javascript:onclick=putOBJxColor2__MODULE_ID__("+z+")'><span class='a01p3'>"+nocol1+"</span></a>&nbsp;&nbsp;&nbsp;&nbsp;<a class='o5582n66' href='javascript:onclick=putOBJxColor2__MODULE_ID__("+xl+")'><span class='a01p3'>"+clos1+"</span></a></td></tr><tr>";var br=1;for(o=0;o<6;o++){mid+='</tr><tr>';for(y=0;y<6;y++){if(y==3){mid+='</tr><tr>';}for(x=0;x<6;x++){var grid='';grid=objX[o]+objX[y]+objX[x];var b="'"+OBjElem+"', '"+Sam+"','#"+grid+"'";mid+='<td class="o5582brd" style="background-color:#'+grid+'"><a class="o5582n66"  href="javascript:onclick=putOBJxColor2__MODULE_ID__('+b+');" onmouseover=javascript:document.getElementById("o5582n66").value="#'+grid+'";javascript:document.getElementById("o5582n66a").style.backgroundColor="#'+grid+'";  title="#'+grid+'"><div style="width:12px;height:14px;"></div></a></td>';c++;}}}mid+="</tr><tr><td colspan='18' align='right' style='padding:2px;border:solid 1px #FFF;background:#FFF;'><a href='"+hm2+"' style='color:#666;font-size:8px;font-family:arial;text-decoration:none;letter-spacing:1px;'>"+tt2+"</a></td></tr></table>";var ttop=getTop2__MODULE_ID__();setCCbldSty2__MODULE_ID__('colorpicker201','tp',ttop);document.getElementById('colorpicker201').style.left=getLeft2__MODULE_ID__();setCCbldSty2__MODULE_ID__('colorpicker201','vs','visible');setCCbldSty2__MODULE_ID__('colorpicker201','ds','block');document.getElementById('colorpicker201').innerHTML=mid;}

	function makeFontSize__MODULE_ID__(){
		var retStr=[], sizeStr=["xsmall", "small", "medium", "large", "xlarge"], dispStr=["__MSG_fSizeXS__", "__MSG_fSizeS__", "__MSG_fSizeM__", "__MSG_fSizeL__", "__MSG_fSizeXL__"], selStr="";
		retStr.push('<select id="fontSize">');
		for(var i=0; i<sizeStr.length; i++){
			selStr=sizeStr[i]==prefArr__MODULE_ID__["fontSize"]?" selected":"";
			retStr.push('<option value="'+sizeStr[i]+'"'+selStr+'>'+dispStr[i]+'</option>');
		}
		retStr.push('</select>');
		return retStr;
	}

	function configChanged__MODULE_ID__(){
		if(_gel("textDiv").value!=prefArr__MODULE_ID__["fontColor"]) return true;
		if(_gel("bgcDiv").value!=prefArr__MODULE_ID__["bgColor"]) return true;
		if(_gel("fontSize").value!=prefs__MODULE_ID__.getString("fontSize")) return true;
		if(_gel("shUrl").value!=prefArr__MODULE_ID__["_table_query_url"]) return true;
		return false;
	}
	
	function configSave__MODULE_ID__(){
		var fC, bC, fS, sU;
		var tempStr=_trim(_gel("textDiv").value);
		if(!colorCheck__MODULE_ID__(tempStr, "Font Color")) return false;
		fC=tempStr;
		tempStr=_trim(_gel("bgcDiv").value);
		if(!colorCheck__MODULE_ID__(tempStr, "Background Color")) return false;
		bC=tempStr;
		fS=_gel("fontSize").value;
		tempStr=_trim(_gel("shUrl").value);
		if(!urlCheck__MODULE_ID__(tempStr)) return false;
		
		prefs__MODULE_ID__.set("fontColor", fC, "bgColor", bC, "fontSize", fS, "shUrl", tempStr);
		prefArr__MODULE_ID__["fontSize"]=fS; prefArr__MODULE_ID__["fontColor"]=fC; prefArr__MODULE_ID__["bgColor"]=bC; prefArr__MODULE_ID__["_table_query_url"]=tempStr;
		return true;
	}

	function colorCheck__MODULE_ID__(color, title){
		var hexTest=new RegExp(/^[#]{1}[0-9a-f]{6}$/i);
		if(color.length==0) return true;
		title=title=="Font Color"?"__MSG_configFontColor__":"__MSG_configBGColor__";
		if(!hexTest.test(color)) {alert('__MSG_configErr__ '+title); return false;}
		return true;
	}
	
	function urlCheck__MODULE_ID__(tempStr){
		if(tempStr.search(/\&/)!=-1) tempStr=tempStr.substring(0, tempStr.indexOf("&"));
		if(tempStr.search(/^http:\/\/spreadsheets\.google\.com\/(ccc|tq|pub)\?key=[a-z0-9\-_]+/i)==-1){ alert('__MSG_configErr__ __MSG_configURL__'); return false;}
		return true;
	}

/* Convert - Reverse Compatibility Functions ***/
	function goConvert__MODULE_ID__(){
		_IG_Analytics("UA-310375-4", "/birthday-gadget/convert");	
		var html=[];
		html.push('<h1>__MSG_convertH1__</h1><div style="text-align: left;"><ol>');
		html.push('<li><a target="_blank" href="'+prefArr__MODULE_ID__["_table_query_url"].replace(/tq\?/, "ccc?")+'">__MSG_convertStep1__</a></li>');
		html.push('<li>__MSG_convertStep2__<br /><textarea id="oldtxt">'+prefArr__MODULE_ID__["birthdays"].replace(/;/g, "\t").replace(/\|/g, "\n")+'</textarea></li>');
		html.push('<li>__MSG_convertStep3__</li><li>__MSG_convertStep4__');
		html.push('<br /><input type="button" value="__MSG_convertClear__" id="clearOld" /></li></ol>');
		html.push('<a href="http://birthday-gadget.googlecode.com/svn/trunk/faq.html" title="Help" target="_blank">__MSG_convertMore__</a></div>');
		tableDivObj__MODULE_ID__.innerHTML = html.join('');		
		_gel('clearOld').onclick=function(){
			prefs__MODULE_ID__.set("birthdays","");
			prefArr__MODULE_ID__["birthdays"]="";
			buildToolbar__MODULE_ID__();
			sendQuery__MODULE_ID__();
		}
		_IG_AdjustIFrameHeight();
	}	

	google.setOnLoadCallback(init__MODULE_ID__);
</script>
]]> 
</Content>
</Module>
