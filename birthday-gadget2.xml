<?xml version="1.0" encoding="UTF-8"?>
<Module>
<ModulePrefs title="__UP_title__"
  directory_title="__MSG_title__"
  description="__MSG_description__"
  screenshot="http://birthday-gadget.googlecode.com/svn/trunk/screenshot.png"
  thumbnail="http://birthday-gadget.googlecode.com/svn/trunk/thumbnail.png"
  author="Adam"
  author_email="birthdaygadget@gmail.com"
  height="100">
    <Locale messages="http://birthday-gadget.googlecode.com/svn/trunk/bd_content/ALL_ALL.xml" />
    <Locale lang="de" messages="http://birthday-gadget.googlecode.com/svn/trunk/bd_content/de_ALL.xml" />
    <Locale lang="es" messages="http://birthday-gadget.googlecode.com/svn/trunk/bd_content/es_ALL.xml" />
    <Locale lang="fr" messages="http://birthday-gadget.googlecode.com/svn/trunk/bd_content/fr_ALL.xml" />
    <Locale lang="it" messages="http://birthday-gadget.googlecode.com/svn/trunk/bd_content/it_ALL.xml" />
    <Locale lang="ko" messages="http://birthday-gadget.googlecode.com/svn/trunk/bd_content/ko_ALL.xml" />
    <Locale lang="ru" messages="http://birthday-gadget.googlecode.com/svn/trunk/bd_content/ru_ALL.xml" />
    <Require feature="analytics" /> 
    <Require feature="dynamic-height" />
    <Require feature="setprefs"/>
</ModulePrefs>
<UserPref name="title" display_name="__MSG_titleName__" required="false" default_value="__MSG_title__" />
<UserPref name="birthdays" datatype="hidden" default_value="YYYY/MM/DD;Name|MM/DD;Name" /> 
<UserPref name="showBDay" display_name="__MSG_showName__" default_value="5" datatype="enum" >
  <EnumValue value="1" />
  <EnumValue value="2" />
  <EnumValue value="3" />
  <EnumValue value="4" />
  <EnumValue value="5" />
  <EnumValue value="6" />
  <EnumValue value="7" />
  <EnumValue value="8" />
  <EnumValue value="9" />
  <EnumValue value="10" />
</UserPref>
<UserPref name="warning" display_name="__MSG_noticeName__" default_value="7" datatype="enum" >
  <EnumValue value="3" />
  <EnumValue value="7" />
  <EnumValue value="10" />
  <EnumValue value="14" />
  <EnumValue value="21" />
</UserPref>
<Content type="html"><![CDATA[
  <style type="text/css">
    #quick__MODULE_ID__{
      font-size: 10px;
      text-align: right;
      width: 100%;
    
    }
  
    #error__MODULE_ID__{
      font-size: 12px;
      color: red;
      padding: 8px;
    }
  
    #table__MODULE_ID__{
      width: 100%;
    }
    .bdtable{
      width: 100%;
      margin: 0;
      padding: 0;
    }
    .bdtable th{
      font-size: 18px;
      border-bottom: 1px solid #000;
    }
    .bdtable td{
      font-size: 16px;
      text-align: center;
    }
  </style>

  <script>
    // Track this gadget using Google Analytics.
    _IG_Analytics("UA-310375-4", "/birthday-gadget");
  </script>

  <script type="text/javascript">
    var prefs__MODULE_ID__ = new _IG_Prefs(__MODULE_ID__);
    var errorStr__MODULE_ID__="";
    var debug__MODULE_ID__="";
    var html__MODULE_ID__="";
    var quickStr__MODULE_ID__="";
    var today=new Date();
     
    String.prototype.trim = function() { return this.replace(/^\s+|\s+$/g,"");}

    function sortDate__MODULE_ID__(a,b){
      splita=a.split(";"); splitb=b.split(";");
      tempa=(splita[0].length>5)?splita[0].substr(5):splita[0];
      tempb=(splitb[0].length>5)?splitb[0].substr(5):splitb[0];
      montha=tempa.substr(0,2); monthb=tempb.substr(0,2);
      daya=tempa.substr(3,2); dayb=tempb.substr(3,2);
      
      if(montha>monthb) return 1;
      else if(montha<monthb) return -1;
      else {
        if(daya>dayb) return 1;
        else if(daya<dayb) return -1;
        else return 0;}}
      
    function formatDate__MODULE_ID__(date){
      var month=new Array(12);
        month[0]="__MSG_ajan__";
        month[1]="__MSG_afeb__";
        month[2]="__MSG_amar__";
        month[3]="__MSG_aapr__";
        month[4]="__MSG_amay__";
        month[5]="__MSG_ajun__";
        month[6]="__MSG_ajul__";
        month[7]="__MSG_aaug__";
        month[8]="__MSG_asep__";
        month[9]="__MSG_aoct__";
        month[10]="__MSG_anov__";
        month[11]="__MSG_adec__";
      if(date.length>5) date=date.substr(5);
      
      test1=date.substr(3,2);
      test2=parseInt(date.substr(3,2), 10);
      
      return month[parseInt(date.substr(0,2))-1]+ " " + parseInt(date.substr(3,2), 10);}
    
    function myPad(num){
      return (num<10)?"0"+num:num;}
      
    function update__MODULE_ID__(){
      var newArray=document.updateForm__MODULE_ID__.updateTextarea__MODULE_ID__.value;
      newArray=newArray.trim();
      newArray=newArray.replace(/\n/g, "|");
      prefs__MODULE_ID__.set("birthdays", newArray);
      
      _IG_Analytics("UA-310375-4", "/birthday-gadget/updated");
      setup__MODULE_ID__("noreload");}
    
    function quickmode__MODULE_ID__(){
      quickStr__MODULE_ID__="<a href=\"#\" onClick=\"setup__MODULE_ID__();\">Back</a>";
      var mainString=prefs__MODULE_ID__.getString("birthdays");
      var numLines=mainString.split("\n").length+1;
      var mainString=mainString.replace(/\|/g, "\n");
      var minLines=5;
      var maxLines=15;
      var finalLines=(numLines>maxLines)?maxLines:numLines;
      var finalLines=(minLines>finalLines)?minLines:finalLines;
    
      errorStr__MODULE_ID__="<span style=\"font-weight: bold;\">One Birthday per line.</span>";
      html__MODULE_ID__="<form name=\"updateForm__MODULE_ID__\">";
      html__MODULE_ID__+="<textarea style=\"width: 100%;\" rows=\""+finalLines+"\" name=\"updateTextarea__MODULE_ID__\">"+mainString+"\n</textarea>";
      html__MODULE_ID__+="<input type=\"button\" value=\"Update\" onClick=\"update__MODULE_ID__();\" onKeyPress=\"update__MODULE_ID__();\" /></form>";
    
      showAll__MODULE_ID__();
    }
    
    
    function setup__MODULE_ID__(loadStatus) {
      if (typeof loadStatus == "undefined") { loadStatus="";}
      errorStr__MODULE_ID__="";
      html__MODULE_ID__="";
      quickStr__MODULE_ID__="<a href=\"#\" onClick=\"quickmode__MODULE_ID__();\">Quick Mode</a>";
      
      var birthdayArray=prefs__MODULE_ID__.getArray("birthdays");
      var year=1000*60*60*24*365;
      var displayArray=new Array();
      birthdayArray.sort(sortDate__MODULE_ID__);
      
      for(var i=0; i<birthdayArray.length; i++){
        tempSplit=birthdayArray[i].split(";");
        
        if(tempSplit.length==1){
          errorStr__MODULE_ID__+="Error: "+birthdayArray[i]+" incorrectly split, use a ';' between date and name.<br />";
          continue;}
        
        date=tempSplit[0];
        name=tempSplit[1];
        if(date=="YYYY/MM/DD" || date=="MM/DD") continue;
        
        if(date.length==5){
          if(/[0-9]{2}\/[0-9]{2}/.test(date)) displayArray.push(Array(date, name));
          else{
            errorStr__MODULE_ID__+="Error: "+birthdayArray[i]+" date is not formatted correctly, use MM/DD.<br />";
            continue;}}
        else if(tempSplit[0].length==10){
          if(/[0-9]{4}\/[0-9]{2}\/[0-9]{2}/.test(date)) displayArray.push(Array(date, name));
          else{
            errorStr__MODULE_ID__+="Error: "+birthdayArray[i]+" date is not formatted correctly, use YYYY/MM/DD.<br />";
            continue;}}
        else{
          errorStr__MODULE_ID__+="Error: "+birthdayArray[i]+" date is not formatted correctly, use YYYY/MM/DD or MM/DD.<br />";
          continue;}}
        
      if(displayArray.length==0) errorStr__MODULE_ID__+="__MSG_none__";
      else{
        html__MODULE_ID__+="<table class=\"bdtable\"><tr><th style=\"width: 20%;\">__MSG_tableDate__</th><th style=\"width: 80%;\">__MSG_tableName__</th><th>__MSG_tableAge__</th></tr>";
        var birthdaysVisible=0;
        var tempWarning=prefs__MODULE_ID__.getInt("warning");
        for(var i=0; i<tempWarning; i++){
          if(birthdaysVisible>=prefs__MODULE_ID__.getInt("showBDay")) break;
          var tempDate=new Date;
          var millisec=tempDate.getTime();
          tempDate.setTime(millisec+i*1000*60*60*24);
          iDate=myPad(tempDate.getMonth()+1)+"/"+myPad(tempDate.getDate());
          for(var j=0; j<displayArray.length; j++){
            jDate=(displayArray[j][0].length>5)?displayArray[j][0].substr(5):displayArray[j][0];
            debug__MODULE_ID__+=i+") "+iDate+" --> "+jDate+"<br />";
            if(birthdaysVisible>=prefs__MODULE_ID__.getInt("showBDay")) break;
            if(jDate==iDate){
              birthdaysVisible++;
              var age="";
              if(displayArray[j][0].length>5){
                var d = new Date();
                var b = Date.parse(displayArray[j][0]);
                age=Math.floor((d-b)/year);
                if(age==0) age=Math.floor(((d-b)/year)*12)+"M";}
              html__MODULE_ID__+="<tr><td>"+formatDate__MODULE_ID__(displayArray[j][0]);
              html__MODULE_ID__+="</td><td>"+displayArray[j][1]+"</td><td>"+age+"</td></tr>";}}}
        html__MODULE_ID__+="</table>";}
      
      if(birthdaysVisible==0){
        html__MODULE_ID__="__MSG_nobd1__ "+prefs__MODULE_ID__.getString("warning")+" __MSG_nobd2__";}
      
      if(loadStatus!="") _IG_Analytics("UA-310375-4", "/birthday-gadget/reloaded");
      showAll__MODULE_ID__();}

    function showAll__MODULE_ID__(){
      _gel("quick__MODULE_ID__").innerHTML=quickStr__MODULE_ID__;
      _gel("error__MODULE_ID__").innerHTML=errorStr__MODULE_ID__;
      //_gel("debug__MODULE_ID__").innerHTML=debug__MODULE_ID__; //debug only
      _gel("table__MODULE_ID__").innerHTML=html__MODULE_ID__;
      _IG_AdjustIFrameHeight();}


    _IG_RegisterOnloadHandler(setup__MODULE_ID__);


  </script>
  <div id="quick__MODULE_ID__"></div>
  <div id="error__MODULE_ID__"></div>
  <div id="debug__MODULE_ID__"></div>
  <div id="table__MODULE_ID__"></div>

]]></Content>
</Module>
